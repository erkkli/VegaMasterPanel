DECLARE @TRH1 AS DATETIME='{TARIH1}'
DECLARE @TRH2 AS DATETIME='{TARIH2}'
DECLARE @KOD1 NVARCHAR(100)='{KOD1}'
DECLARE @URUNADI AS NVARCHAR(100)='{URUNADI}'
DECLARE @SUBEADI AS NVARCHAR(100)='{SUBEADI}'


SELECT *,(t.Tutar/t.ToplamCiro)*100 as CiroOranOran,
(t.AdetMiktar/t.ToplamMiktar)*100 as [Toplam%Miktar]
FROM (
SELECT 
case WHEN DATEPART(HOUR, [date])=0 THEN 24 else  DATEPART(HOUR, [date]) end  as Saat,
sum(case when  ISNULL(KOD3,'')<>'KG' and KOD1 LIKE '%DONER%' THEN (Quantity*AGIRLIK)*10 ELSE 0 END) As AdetMiktar,
sum(case when  ISNULL(KOD3,'')='KG' and KOD1 LIKE '%DONER%' THEN (Quantity*AGIRLIK)*10 ELSE 0 END) As KilolukMiktar,
SUM(case when KOD1 LIKE '%DONER%' THEN (Quantity*Price)ELSE 0 END) as Tutar,
(SELECT SUM(Quantity*Price) FROM  [dbo].[Bill] where  Date>=@TRH1  AND Date<=@TRH2 #KOD1WHERE# #URUNADIWHERE# #TEKTRHWHERE# #SUBEADIWHERE# #BELÝRLÝSAATLER# #PORSIYONTIPIWHERE#) as ToplamCiro,
(SELECT SUM(Quantity*AGIRLIK)*10 FROM  [dbo].[Bill] where  Date>=@TRH1  AND Date<=@TRH2 and KOD1 LIKE '%DONER%' #KOD1WHERE# #URUNADIWHERE# #TEKTRHWHERE# #SUBEADIWHERE# #BELÝRLÝSAATLER# #PORSIYONTIPIWHERE#) as SubeToplamMiktar,
(SELECT SUM(Quantity*AGIRLIK)*10 FROM  [dbo].[Bill] where  Date>=@TRH1  AND Date<=@TRH2 AND  KOD1 LIKE '%DONER%' #KOD1WHERE# #URUNADIWHERE# #TEKTRHWHERE# #SUBEADIWHERE# #BELÝRLÝSAATLER# #PORSIYONTIPIWHERE#) as ToplamMiktar

 FROM [dbo].[Bill] AS HR
WHERE Date>=@TRH1  AND Date<=@TRH2 #KOD1WHERE# #URUNADIWHERE# #TEKTRHWHERE# #SUBEADIWHERE# #BELÝRLÝSAATLER# #PORSIYONTIPIWHERE#

group by
case WHEN DATEPART(HOUR, [date])=0 THEN 24 else  DATEPART(HOUR, [date]) end
) AS T 