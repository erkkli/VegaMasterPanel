
declare @Sube nvarchar(100) = '{SUBEADI}';
declare @Sube2 nvarchar(100) = '{SUBE2}';
declare @Kasa nvarchar(100) = '{KASAKODU}';
declare @Trh1 nvarchar(20) = '{TARIH1}';
declare @Trh2 nvarchar(20) = '{TARIH2}';

WITH Toplamsatis AS 
(
--nakit
SELECT 
@Sube as Sube, 
(TUTAR*KUR) AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,
0 AS zayi , 0 PaketToplam
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=1 AND IADE=0 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

UNION ALL
SELECT 
@Sube as Sube, 
(TUTAR*KUR)*-1 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,
0 AS zayi , 0 PaketToplam
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=1 AND IADE=1 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

--kredi kartý
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, (TUTAR*KUR) AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,
0 AS zayi , 0 PaketToplam
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=2 AND IADE=0 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, (TUTAR*KUR)*-1 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,
0 AS zayi , 0 PaketToplam
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=2 AND IADE=1 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

--ticket hediyeceki
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, (TUTAR*KUR)  AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,
0 AS zayi , 0 PaketToplam
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=3 AND IADE=0 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, (TUTAR*KUR)*-1 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,
0 AS zayi , 0 PaketToplam
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=3 AND IADE=1 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

--acikhesap
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0  AS Ticket, (TUTAR*KUR) AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,
0 AS zayi , 0 PaketToplam
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=4 AND IADE=0 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, (TUTAR*KUR)*-1 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,
0 AS zayi , 0 PaketToplam
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=4 AND IADE=1 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

--satýþadet
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0  AS Ticket, 0 AS Debit, 0 AS ikram, COUNT(*) AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,
0 AS zayi , 0 PaketToplam
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE IADE=0 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, COUNT(*)*-1 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,
0 AS zayi , 0 PaketToplam
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE IADE=1 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

--iade

UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,sum(TUTAR) iade,
0 AS zayi , 0 PaketToplam
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE IADE=1 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

--indirim
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0  AS Ticket,0 AS Debit, 0 AS ikram, 0 AS TableNo,  (H.ISKTUTARI)  AS Discount, 0 AS iptal,0 AS iade,
0 AS zayi , 0 PaketToplam
FROM TBLSPOSSATISHAREKET H WITH(NOLOCK)
LEFT JOIN TBLSPOSSATISBASLIK B WITH(NOLOCK) ON B.IND=H.BASLIKIND
WHERE ISKORANI1>0  AND IADE=0 AND B.IPTAL=0 AND B.OLUSTURMATARIHI>=@Trh1 AND B.OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo,  (H.ISKTUTARI)*-1  AS Discount, 0 AS iptal,0 AS iade,
0 AS zayi , 0 PaketToplam
FROM TBLSPOSSATISHAREKET H WITH(NOLOCK)
LEFT JOIN TBLSPOSSATISBASLIK B WITH(NOLOCK) ON B.IND=H.BASLIKIND
WHERE ISKORANI1>0 AND B.IADE=1 AND B.IPTAL=0 AND B.OLUSTURMATARIHI>=@Trh1 AND B.OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

--iptal
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo,  0  AS Discount, MIKTAR*FIYAT AS iptal,0 AS iade,
0 AS zayi , 0 PaketToplam
FROM TBLSPOSSATISHAREKETLOG H WITH(NOLOCK)
LEFT JOIN TBLSPOSSATISBASLIKLOG B WITH(NOLOCK) ON B.IND=H.BASLIKIND
WHERE  B.IADE=0 AND B.IPTAL=0 AND B.OLUSTURMATARIHI>=@Trh1 AND B.OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

--paket
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo,  0  AS Discount, 0 AS iptal,0 AS iade,
0 AS zayi , sum(b.TUTAR) PaketToplam
FROM TBLSPOSSATISBASLIK B WITH(NOLOCK)
WHERE  B.IADE=0 AND B.IPTAL=0 AND ISNULL(B.P_KAYNAK,'')<>'' AND B.OLUSTURMATARIHI>=@Trh1 AND B.OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)
 )

SELECT Sube 
,SUM(Cash) AS Cash 
,SUM(Credit) AS Credit 
,Sum(Ticket) AS Ticket 
,SUM(PaketToplam) as PaketToplam
,Sum(Debit) AS Debit 
,Sum(ikram) AS ikram 
,Sum(TableNo) AS TableNo 
,Sum(Discount) AS Discount 
,Sum(iade) AS iade 
,Sum(iptal) AS iptal 
,Sum(Zayi) AS Zayi
,SUM(Cash+Credit+Ticket+Debit) AS ToplamCiro
,0 AS Saniye
,'' AS RowStyle
,'' AS RowError
FROM toplamsatis  
GROUP BY Sube