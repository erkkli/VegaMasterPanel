      
declare @par1 nvarchar(20) = '{TARIH1}';
declare @par2 nvarchar(20) = '{TARIH2}';
declare @Sube nvarchar(100) = '{SUBEADI}';
declare @Sube2 nvarchar(100) = '{SUBE2}';
declare @Kasa nvarchar(100) = '{KASAKODU}';

		WITH SATIS AS 
		(
		SELECT 
		COUNT(*) SAY, 
		SUM(TUTAR) BTUTAR
		,MAX(ISNULL(ADI,'')+'/'+ISNULL(SOYADI,'')) PLASIYER 
		
		FROM  TBLSPOSSATISBASLIK AS BAS WITH(NOLOCK)
	LEFT JOIN TBLSPOSPAKETCILER AS P WITH(NOLOCK) ON P.IND=P_PAKETCIIND
		 WHERE ISNULL(BAS.IsDeleted,0)=0 AND ISNULL(BAS.IPTAL,0)=0 AND ISNULL(BAS.BEKLEYENFIS,0)=0 AND ISNULL(P_KAYNAK,'')<>''
		 AND BAS.OLUSTURMATARIHI>=@par1 AND BAS.OLUSTURMATARIHI<=@par2
		            AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
					AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)
					--GROUP BY P.ADI,P.SOYADI
					),


		    SATIS_TAHSILAT AS (
                SELECT 
					SAY,
					BTUTAR,	
					PLASIYER,
					SUM(INDIRIM) INDIRIM,
                    P_KAYNAK,
                    IADE,
                    0 AS BEKLEYENFIS,
                    SUM(Cash) AS Cash,
                    SUM(Credit) AS Credit,
                    SUM(Ticket) AS Ticket,
                    SUM(Debit) AS Debit,
					SUM(OnlinePayment) AS OnlinePayment,
					SUM(OnlineDiscount) AS OnlineDiscount,
					SUM(GETIR) AS GETIR,
					SUM(TRENDYOL) AS TRENDYOL,
					SUM(YEMEKSEPETI) AS YEMEKSEPETI,
					SUM(MIGROSYEMEK) AS MIGROSYEMEK

                FROM (SELECT
                SAY,BTUTAR,PLASIYER,
                 (SELECT ISNULL(P_KAYNAK,'') FROM TBLSPOSSATISBASLIK WHERE  IND=T.SATISBASLIKIND ) AS P_KAYNAK,
				 (SELECT TUTAR FROM TBLSPOSSATISBASLIK WHERE  IND=T.SATISBASLIKIND ) AS TUTAR,
				 (SELECT SUM(ISKTUTARI)  FROM TBLSPOSSATISHAREKET H WITH(NOLOCK)  WHERE  H.BASLIKIND=T.SATISBASLIKIND) AS INDIRIM,
                 IADE,
                 ISLEMTIPI,

                 CASE WHEN ISLEMTIPI=1 THEN (TUTAR*KUR) ELSE 0 END Cash,
                 CASE WHEN ISLEMTIPI=2 THEN (TUTAR*KUR) ELSE 0 END Credit,
                 CASE WHEN ISLEMTIPI=3 THEN (TUTAR*KUR) ELSE 0 END Ticket,
                 CASE WHEN ISLEMTIPI=4 THEN (TUTAR*KUR) ELSE 0 END Debit,
				   CASE WHEN ISLEMTIPI=99 THEN (TUTAR*KUR) ELSE 0 END OnlinePayment,
				   CASE WHEN ISLEMTIPI=88 THEN (TUTAR*KUR) ELSE 0 END OnlineDiscount,
				   CASE WHEN ISLEMTIPI=99 and ACIKLAMA='GETIR' THEN (TUTAR*KUR) ELSE 0 END GETIR,
				   CASE WHEN ISLEMTIPI=99 and ACIKLAMA='TRENDYOL' THEN (TUTAR*KUR) ELSE 0 END TRENDYOL,
				   CASE WHEN ISLEMTIPI=99 and ACIKLAMA='YEMEKSEPETI'  THEN (TUTAR*KUR) ELSE 0 END YEMEKSEPETI,
				   CASE WHEN ISLEMTIPI=99 and ACIKLAMA='MIGROSYEMEK'  THEN (TUTAR*KUR) ELSE 0 END MIGROSYEMEK

                 FROM SATIS,TBLSPOSSATISTAHSILAT AS T WITH(NOLOCK) 
                 WHERE ISNULL(IsDeleted,0)=0
					  AND T.OLUSTURMATARIHI>=@par1 AND T.OLUSTURMATARIHI<=@par2 
                    AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
					AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0) 
					AND (SELECT ISNULL(P_KAYNAK,'') FROM TBLSPOSSATISBASLIK WITH(NOLOCK)  WHERE  IND=T.SATISBASLIKIND ) <>''

                GROUP BY IADE,ISLEMTIPI,IND,TUTAR,KUR,SATISBASLIKIND,CAST(ACIKLAMA AS NVARCHAR(50)),SAY,BTUTAR,PLASIYER
                 )  AS T GROUP BY IADE,P_KAYNAK,SAY,BTUTAR,PLASIYER
                )


		SELECT 
		
		PLASIYER Deliverer,
		SAY OrderCount,
		BTUTAR+INDIRIM Total,
		ISNULL(Debit,0) Debit,
		ISNULL(Cash,0) CashPayment, 
		ISNULL(Credit,0) CreditPayment,
		ISNULL(Ticket,0) TicketPayment,	
		ISNULL(OnlinePayment,0) OnlinePayment,
		ISNULL(GETIR,0) GETIR,
		ISNULL(TRENDYOL,0) TRENDYOL,
		ISNULL(YEMEKSEPETI,0) YEMEKSEPETI,	
		INDIRIM Discount,
		0 CollectedTotal,
		0 Balance,
		ISNULL(OnlineDiscount,0) OnlineDiscount,
		ISNULL(MIGROSYEMEK,0) MIGROSYEMEK
		
		


		FROM  SATIS_TAHSILAT H WITH(NOLOCK) 
