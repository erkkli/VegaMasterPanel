
declare @Sube nvarchar(100) = '{SUBEADI}';
declare @Sube2 nvarchar(100) = '{SUBE2}';
declare @Kasa nvarchar(100) = '{KASAKODU}';
declare @Trh1 nvarchar(20) = '{TARIH1}';
declare @Trh2 nvarchar(20) = '{TARIH2}';

WITH Toplamsatis AS 
(
--nakit
SELECT 
@Sube as Sube, 
(TUTAR*KUR) AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS OnlinePayment, 0 AS gelirgider
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=1 AND IADE=0 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

UNION ALL
SELECT 
@Sube as Sube, 
(TUTAR*KUR)*-1 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS OnlinePayment, 0 AS gelirgider
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=1 AND IADE=1 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

--kredi kartý
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, (TUTAR*KUR) AS Credit, 0 AS Ticket, 0 AS OnlinePayment, 0 AS gelirgider
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=2 AND IADE=0 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, (TUTAR*KUR)*-1 AS Credit, 0 AS Ticket, 0 AS OnlinePayment, 0 AS gelirgider
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=2 AND IADE=1 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

--ticket hediyeceki
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, (TUTAR*KUR)  AS Ticket, 0 AS OnlinePayment, 0 AS gelirgider
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=3 AND IADE=0 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, (TUTAR*KUR)*-1 AS Ticket, 0 AS OnlinePayment, 0 AS gelirgider
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=3 AND IADE=1 AND IPTAL=0 AND OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

--gelirgider
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS OnlinePayment, H.TUTAR AS gelirgider
FROM TBLSPOSTAHSILATHAREKET H WITH(NOLOCK)
LEFT JOIN TBLSPOSTAHSILATBASLIK B WITH(NOLOCK) ON B.IND=H.BASLIKIND
WHERE  B.IADE=0 AND B.IPTAL=0 AND B.OLUSTURMATARIHI>=@Trh1 AND B.OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS OnlinePayment, H.TUTAR*-1 AS gelirgider
FROM TBLSPOSODEMEHAREKET H WITH(NOLOCK)
LEFT JOIN TBLSPOSODEMEBASLIK B WITH(NOLOCK) ON B.IND=H.BASLIKIND
WHERE  B.IADE=0 AND B.IPTAL=0 AND B.OLUSTURMATARIHI>=@Trh1 AND B.OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS OnlinePayment, (GELIR-GIDER) AS gelirgider
FROM TBLSPOSKASAHAREKETLERI WITH(NOLOCK)
WHERE   OLUSTURMATARIHI>=@Trh1 AND OLUSTURMATARIHI<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

)

SELECT Sube 
,SUM(Cash) AS Cash 
,SUM(Credit) AS Credit 
,Sum(Ticket) AS Ticket 
,0 AS OnlinePayment
,SUM(gelirgider) as GelirGider
,SUM(Cash)  + SUM(Credit) +Sum(Ticket) As ToplamCiro
FROM toplamsatis  
GROUP BY Sube