      
declare @par1 nvarchar(20) = '{TARIH1}';
declare @par2 nvarchar(20) = '{TARIH2}';
declare @Sube nvarchar(100) = '{SUBEADI}';
declare @Sube2 nvarchar(100) = '{SUBE2}';
declare @Kasa nvarchar(100) = '{KASAKODU}';

WITH Toplamsatis AS 
(
--nakit
SELECT 

(TUTAR*KUR) AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS OnlinePayment, 0 AS gelirgider, 0 Discount, ISNULL(K.KODU,'')+'-'+ISNULL(K.ADI,'') ReceivedByUserName
FROM TBLSPOSSATISTAHSILAT  T WITH(NOLOCK)
LEFT JOIN TBLSPOSKULLANICILAR K WITH(NOLOCK) ON K.IND=KULLANICIIND
WHERE ISLEMTIPI=1 AND IADE=0 AND IPTAL=0 AND T.OLUSTURMATARIHI>=@par1 AND T.OLUSTURMATARIHI<=@par2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

UNION ALL
SELECT 

(TUTAR*KUR)*-1 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS OnlinePayment, 0 AS gelirgider, 0 Discount, ISNULL(K.KODU,'')+'-'+ISNULL(K.ADI,'') ReceivedByUserName
FROM TBLSPOSSATISTAHSILAT T WITH(NOLOCK)
LEFT JOIN TBLSPOSKULLANICILAR K WITH(NOLOCK) ON K.IND=KULLANICIIND
WHERE ISLEMTIPI=1 AND IADE=1 AND IPTAL=0 AND T.OLUSTURMATARIHI>=@par1 AND T.OLUSTURMATARIHI<=@par2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

--kredi kartı
UNION ALL
SELECT 

0 AS Cash, (TUTAR*KUR) AS Credit, 0 AS Ticket, 0 AS OnlinePayment, 0 AS gelirgider, 0 Discount, ISNULL(K.KODU,'')+'-'+ISNULL(K.ADI,'') ReceivedByUserName
FROM TBLSPOSSATISTAHSILAT T WITH(NOLOCK)
LEFT JOIN TBLSPOSKULLANICILAR K WITH(NOLOCK) ON K.IND=KULLANICIIND
WHERE ISLEMTIPI=2 AND IADE=0 AND IPTAL=0 AND T.OLUSTURMATARIHI>=@par1 AND T.OLUSTURMATARIHI<=@par2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

UNION ALL
SELECT 

0 AS Cash, (TUTAR*KUR)*-1 AS Credit, 0 AS Ticket, 0 AS OnlinePayment, 0 AS gelirgider, 0 Discount, ISNULL(K.KODU,'')+'-'+ISNULL(K.ADI,'') ReceivedByUserName
FROM TBLSPOSSATISTAHSILAT T WITH(NOLOCK)
LEFT JOIN TBLSPOSKULLANICILAR K WITH(NOLOCK) ON K.IND=KULLANICIIND
WHERE ISLEMTIPI=2 AND IADE=1 AND IPTAL=0 AND T.OLUSTURMATARIHI>=@par1 AND T.OLUSTURMATARIHI<=@par2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

--ticket hediyeceki
UNION ALL
SELECT 

0 AS Cash, 0 AS Credit, (TUTAR*KUR)  AS Ticket, 0 AS OnlinePayment, 0 AS gelirgider, 0 Discount, ISNULL(K.KODU,'')+'-'+ISNULL(K.ADI,'') ReceivedByUserName
FROM TBLSPOSSATISTAHSILAT T WITH(NOLOCK)
LEFT JOIN TBLSPOSKULLANICILAR K WITH(NOLOCK) ON K.IND=KULLANICIIND
WHERE ISLEMTIPI=3 AND IADE=0 AND IPTAL=0 AND T.OLUSTURMATARIHI>=@par1 AND T.OLUSTURMATARIHI<=@par2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)
UNION ALL
SELECT 

0 AS Cash, 0 AS Credit, (TUTAR*KUR)*-1 AS Ticket, 0 AS OnlinePayment, 0 AS gelirgider, 0 Discount, ISNULL(K.KODU,'')+'-'+ISNULL(K.ADI,'') ReceivedByUserName
FROM TBLSPOSSATISTAHSILAT T WITH(NOLOCK)
LEFT JOIN TBLSPOSKULLANICILAR K WITH(NOLOCK) ON K.IND=KULLANICIIND
WHERE ISLEMTIPI=3 AND IADE=1 AND IPTAL=0 AND T.OLUSTURMATARIHI>=@par1 AND T.OLUSTURMATARIHI<=@par2 
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)


--açık hesap
UNION ALL
SELECT 

0 AS Cash, 0 AS Credit, 0  AS Ticket, 0 AS OnlinePayment, (TUTAR*KUR) AS gelirgider, 0 Discount, ISNULL(K.KODU,'')+'-'+ISNULL(K.ADI,'') ReceivedByUserName
FROM TBLSPOSSATISTAHSILAT T WITH(NOLOCK)
LEFT JOIN TBLSPOSKULLANICILAR K WITH(NOLOCK) ON K.IND=KULLANICIIND
WHERE ISLEMTIPI=4 AND IADE=0 AND IPTAL=0 AND T.OLUSTURMATARIHI>=@par1 AND T.OLUSTURMATARIHI<=@par2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

UNION ALL
SELECT 

0 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS OnlinePayment, (TUTAR*KUR)*-1 AS gelirgider, 0 Discount, ISNULL(K.KODU,'')+'-'+ISNULL(K.ADI,'') ReceivedByUserName
FROM TBLSPOSSATISTAHSILAT T WITH(NOLOCK)
LEFT JOIN TBLSPOSKULLANICILAR K WITH(NOLOCK) ON K.IND=KULLANICIIND
WHERE ISLEMTIPI=4 AND IADE=1 AND IPTAL=0 AND T.OLUSTURMATARIHI>=@par1 AND T.OLUSTURMATARIHI<=@par2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

UNION ALL
SELECT 

0 AS Cash, 0 AS Credit, 0  AS Ticket, 0 AS OnlinePayment, 0 AS gelirgider,  (H.ISKTUTARI)  AS Discount, ISNULL(K.KODU,'')+'-'+ISNULL(K.ADI,'') ReceivedByUserName
FROM TBLSPOSSATISHAREKET H WITH(NOLOCK)
LEFT JOIN TBLSPOSSATISBASLIK B WITH(NOLOCK) ON B.IND=H.BASLIKIND
LEFT JOIN TBLSPOSKULLANICILAR K WITH(NOLOCK) ON K.IND=B.KULLANICIIND
WHERE ISKORANI1>0  AND IADE=0 AND B.IPTAL=0 AND B.OLUSTURMATARIHI>=@par1 AND B.OLUSTURMATARIHI<=@par2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)
UNION ALL
SELECT 

0 AS Cash, 0 AS Credit, 0 AS Ticket,  0 AS OnlinePayment, 0 AS gelirgider,  (H.ISKTUTARI)*-1  AS Discount, ISNULL(K.KODU,'')+'-'+ISNULL(K.ADI,'') ReceivedByUserName
FROM TBLSPOSSATISHAREKET H WITH(NOLOCK)
LEFT JOIN TBLSPOSSATISBASLIK B WITH(NOLOCK) ON B.IND=H.BASLIKIND
LEFT JOIN TBLSPOSKULLANICILAR K WITH(NOLOCK) ON K.IND=B.KULLANICIIND
WHERE ISKORANI1>0 AND B.IADE=1 AND B.IPTAL=0 AND B.OLUSTURMATARIHI>=@par1 AND B.OLUSTURMATARIHI<=@par2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

)


SELECT 
 SUM(0) amount
 ,(SUM(Cash) + SUM(Credit) + SUM(Ticket) ) as Total

,SUM(Cash) AS CashPayment 
,SUM(Credit) AS CreditPayment 
,Sum(Ticket) AS TicketPayment 
, SUM(gelirgider) Debit
, SUM(Discount) Discount
,ReceivedByUserName ReceivedByUserName
FROM toplamsatis  
 GROUP BY ReceivedByUserName
