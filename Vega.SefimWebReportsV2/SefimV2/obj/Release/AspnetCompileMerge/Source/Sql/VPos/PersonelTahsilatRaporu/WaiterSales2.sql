      
declare @par1 nvarchar(20) = '{TARIH1}';
declare @par2 nvarchar(20) = '{TARIH2}';
declare @Sube nvarchar(100) = '{SUBEADI}';
declare @Sube2 nvarchar(100) = '{SUBE2}';
declare @Kasa nvarchar(100) = '{KASAKODU}';
	
WITH Toplamsatis AS 
(

SELECT 
 
H.MIKTAR,((H.MIKTAR*H.FIYAT)-H.ISKTUTARI) TUTAR, ISNULL(K.KODU,'')+'-'+ISNULL(K.ADI,'') UserName
FROM TBLSPOSSATISHAREKET H WITH(NOLOCK)
LEFT JOIN TBLSPOSSATISBASLIK B WITH(NOLOCK) ON B.IND=H.BASLIKIND
LEFT JOIN TBLSPOSPERSONELLER K WITH(NOLOCK) ON K.IND=H.PERSONELIND
WHERE  B.IADE=0 AND ISNULL(B.BEKLEYENFIS,0)=0 AND B.IPTAL=0 AND B.OLUSTURMATARIHI>=@par1 AND B.OLUSTURMATARIHI<=@par2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

UNION ALL SELECT 
 
H.MIKTAR*-1,((H.MIKTAR*H.FIYAT)-H.ISKTUTARI)*-1 TUTAR, ISNULL(K.KODU,'')+'-'+ISNULL(K.ADI,'') UserName
FROM TBLSPOSSATISHAREKET H WITH(NOLOCK)
LEFT JOIN TBLSPOSSATISBASLIK B WITH(NOLOCK) ON B.IND=H.BASLIKIND
LEFT JOIN TBLSPOSPERSONELLER K WITH(NOLOCK) ON K.IND=H.PERSONELIND
WHERE  B.IADE=1 AND ISNULL(B.BEKLEYENFIS,0)=0 AND B.IPTAL=0 AND B.OLUSTURMATARIHI>=@par1 AND B.OLUSTURMATARIHI<=@par2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)

),
islemsayisi AS 
(

SELECT 
  case when B.IADE=0 THEN 1 ELSE -1 END SAY
FROM TBLSPOSSATISHAREKET H WITH(NOLOCK)
LEFT JOIN TBLSPOSSATISBASLIK B WITH(NOLOCK) ON B.IND=H.BASLIKIND
LEFT JOIN TBLSPOSPERSONELLER K WITH(NOLOCK) ON K.IND=H.PERSONELIND
WHERE  ISNULL(B.BEKLEYENFIS,0)=0 AND B.IPTAL=0 AND B.OLUSTURMATARIHI>=@par1 AND B.OLUSTURMATARIHI<=@par2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND Charindex('&'+KODU+'&',@kasa)>0)
GROUP BY B.IND,B.IADE


)



SELECT 

(select SUM(SAY) from islemsayisi) islemsayisi,

UserName AS PERKODU,sum(TUTAR) TUTAR , SUM(MIKTAR) AS MIKTAR
FROM Toplamsatis b
GROUP BY UserName