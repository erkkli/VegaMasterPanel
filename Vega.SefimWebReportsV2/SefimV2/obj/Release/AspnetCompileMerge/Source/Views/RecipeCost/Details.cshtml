
@model IEnumerable<SefimV2.Models.SubeUrun>
@using SefimV2.Models

@{
    var StartDateTime = ViewBag.StartDateTime;
    var EndDateTime = ViewBag.EndDateTime;
}

@*<button type="button" class="btn btn-success" id="btnExport" onclick="fnExcelReport();" style="float: right;"><i class="fa fa-file-excel-o"></i> - Excel</button>*@
<button id="btnRangeDetail" class="btn btn-danger pull-right " type="button" data-toggle="modal" data-target="#modalEpostaFormDetail"> <i class="fa fa-mail-forward"></i>E-Posta   </button>
<table id="tableSubeReceteDetay" class="table datatable table-bordered  table-condensed">
    @{
        <thead>
            <tr style="background-color:#fee7e4">
                <th class="column-title">Ürün</th>
                <th class="column-title" style="text-align:right">Miktar</th>
                <th class="column-title" style="text-align:right">Tutar</th>
                <th class="column-title" style="text-align:right">İkram</th>
                <th class="column-title" style="text-align:right">İndirim</th>
                <th class="column-title" style="text-align:right">Net Tutar</th>
                <th width="7%" class="column-title" style="text-align:right">Recete Maliyeti</th>
                <th width="9%" class="column-title" style="text-align:right">Recete Top. Miktarı</th>
                <th width="7%" class="column-title" style="text-align:right">Birim Maliyeti </th>
                <th width="7%" class="column-title" style="text-align:right">Kar Tutari </th>
                <th width="7%" class="column-title" style="text-align:right">Kar Oranı </th>
            </tr>
        </thead>
        <tbody class="liste">
            @foreach (var item in Model)
            {

                var netKalan = item.Debit - (item.ReceteBirimMaliyeti);

                //var karOrani = item.ReceteBirimMaliyeti != 0 ? (netKalan * 100) / (item.ReceteBirimMaliyeti != 0 ? item.ReceteBirimMaliyeti : 1) : 0;

                //var karOrani = item.ReceteBirimMaliyeti != 0 ? (netKalan) / (item.ReceteBirimMaliyeti != 0 ? item.ReceteBirimMaliyeti : 1) : 0;
                decimal karOrani = 0;
                if (item.Debit != 0 && item.ReceteTutari != 0)
                {
                    karOrani = ((item.Debit - item.ReceteTutari) * 100) / (item.ReceteTutari);
                }



                <tr class="link" style="color:#000000;font-weight:bold ">
                    <td>
                        @*<img src="~/img/details_open.jpg" width="24" height="24" rel=@string.Format(HttpUtility.UrlEncode(  item.ProductName),  System.Text.UTF8Encoding.Default) alt="expand/collapse"> @item.ProductName*@
                        <img src="~/img/details_open.jpg" rel=@item.ProductName.Replace(" ", "_").ToString().Replace("&", "]") alt="expand/collapse"> @item.ProductName
                    </td>
                    <td style="text-align:right"> @decimal.Round(item.Miktar, 2, MidpointRounding.AwayFromZero)   @*@String.Format("{0:0.##}", item.Miktar)*@</td>
                    <td style="text-align:right"> @decimal.Round(item.Debit, 2, MidpointRounding.AwayFromZero)   @*@String.Format("{0:0.##}", item.Debit)*@ @*@String.Format("{0:#,###.00;-#,###.00;0}", item.Debit)*@ </td>
                    <td style="text-align:right"> @decimal.Round(item.Ikram, 2, MidpointRounding.AwayFromZero)  </td>
                    <td style="text-align:right"> @decimal.Round(item.Indirim, 2, MidpointRounding.AwayFromZero)  </td>
                    <td style="text-align:right">@item.NetTutar.ToString("C")  @*@decimal.Round(item.NetTutar, 2, MidpointRounding.AwayFromZero)*@  </td>
                    <td style="text-align:right;"> @item.ReceteTutari.ToString("C")  @*@decimal.Round(item.ReceteTutari, 2, MidpointRounding.AwayFromZero)*@  </td>
                    <td style="text-align:right;"> @decimal.Round(item.ReceteToplamMiktari, 2, MidpointRounding.AwayFromZero)  </td>
                    <td style="text-align:right;"> @decimal.Round(item.ReceteBirimMaliyeti, 2, MidpointRounding.AwayFromZero)  </td>
                    @*<td style="text-align:right;"> @decimal.Round(item.KarTutari, 2, MidpointRounding.AwayFromZero)  </td>*@
                    <td style="text-align:right;">@item.KarTutari.ToString("C")  </td>
                    <td style="text-align:right;">% @decimal.Round(karOrani, 2, MidpointRounding.AwayFromZero) </td>
                </tr>
            }
        </tbody>
    }
</table>

<div class="modal fade" id="modalEpostaFormDetail" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">E-Posta Gönder</h4>
            </div>
            <div class="modal-body">
                <div class="clearfix"></div>
                <div class="form-group" style="margin-top:10px !important;">
                    <div class="col-md-9 col-sm-9 col-xs-12">
                        <div class="controls">
                            <div class="form-group m-form__group row  has-feedback ">
                                <label class="col-form-label col-lg-3 col-sm-12">E-Posta </label>
                                <div class="col-lg-9 col-md-9 col-sm-12">
                                    @*<input type="text" name="Name" id="ePostaAdress" />*@
                                    <input type="email" id="ePostaAdress" class="form-control" aria-describedby="emailHelp" placeholder="E Posta Giriniz">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="clearfix"></div>
                <div class="clearfix"></div>
            </div>
            <div class="modal-footer">
                <button id="btnEpostasaveDetail" type="button" class="btnEpostasave btn btn-success" data-id="0"> <i class="fa fa-mail-forward"></i> Gönder</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalExportDetail" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">E-Posta Gönder</h4>
            </div>
            <div class="modal-body">
                <div class="clearfix"></div>
                <div class="form-group" style="margin-top:10px !important;">
                    <div class="col-md-9 col-sm-9 col-xs-12">
                        <div class="controls">
                            <div class="form-group m-form__group row  has-feedback ">
                                <label class="col-form-label col-lg-3 col-sm-12">E-Posta </label>
                                <div class="col-lg-9 col-md-9 col-sm-12">
                                    @*<input type="text" name="Name" id="ePostaAdress" />*@
                                    @*<input type="email" id="ePostaAdress" class="form-control" aria-describedby="emailHelp" placeholder="E Posta Giriniz">*@
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="clearfix"></div>
                <div class="clearfix"></div>
            </div>
            <div class="modal-footer">
                <button id="btnExcelExportDetail" type="button" class="btnEpostasave btn btn-success" data-id="0"> <i class="fa fa-mail-forward"></i> Gönder</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>
@*<script src="/Assets/js/jquery.js"></script>
    <script src="/Assets/plugins/fUpload/jquery.blockUI.js"></script>
    <script src="/Assets/js/bootstrap.js"></script>*@


<script type="text/javascript">
    $(document).ready(function () {

        var buttonCommon = {
            exportOptions: {
                format: {
                    body: function (data, row, column, node) {
                        console.log(" data_", data);
                        return data.replace(/[$,.]/g, '.')
                        data;
                    }
                }
            }
        };

        $('#tableSubeReceteDetay').DataTable({
            language: {
                info: "_TOTAL_ kayıttan _START_ - _END_ kayıt gösteriliyor.",
                infoEmpty: "Gösterilecek hiç kayıt yok.",
                loadingRecords: "Kayıtlar yükleniyor.",
                zeroRecords: "Tablo boş",
                search: "Arama:",
                infoFiltered: "(toplam _MAX_ kayıttan filtrelenenler)",
                buttons: {
                    copyTitle: "Panoya kopyalandı.",
                    copySuccess: "Panoya %d satır kopyalandı",
                    copy: "Kopyala",
                    print: "Yazdır",
                },
                paginate: {
                    first: "İlk",
                    previous: "Önceki",
                    next: "Sonraki",
                    last: "Son"
                },
            },
            dom: 'Bfrtip',
            "pageLength": 500,
            "bDestroy": true,
            //buttons: [
            //    'copy', 'excel', 'pdf', 'print'
            //],

            buttons: [
                $.extend(true, {}, buttonCommon, {
                    extend: 'copyHtml5'
                }),
                $.extend(true, {}, buttonCommon, {
                    extend: 'excelHtml5'
                }),
                $.extend(true, {}, buttonCommon, {
                    extend: 'pdfHtml5'
                }),
                //$.extend(true, {}, buttonCommon, {
                //    extend: 'printHtml5'
                //})
                'print'
            ],
            //responsive: true
        });

    });
</script>

<script>
    //$('#example').on('click', '.btn-edit', function () {
    //    // ...
    //});

    //$('#tableSubeReceteDetay tbody td img').click(function () {
    $('#tableSubeReceteDetay tbody td img').on('click', function () {
        var oTable = $('#tableSubeReceteDetay').dataTable();
        var nTr = this.parentNode.parentNode;

        if (this.src.match('details_close')) {
            /* This row is already open - close it */
            this.src = "/img/details_open.jpg";
            oTable.fnClose(nTr);
        }
        else {
            /* Open this row */
            this.src = "/img/details_close.jpg";
            var productName = $(this).attr("rel").toString();
            $.get("ProductDetails?durum=" + localStorage.durum + "&tarihBas=" + localStorage.tarihBaslangic + "&tarihBitis=" + localStorage.tarihBitis + "&subeid=" + localStorage.subeid + "&productName=" + productName, function (details) {
                oTable.fnOpen(nTr, details, 'details');
            });
        }
    });



    //  //Veri Getir butonu click durumu
    //$(document).on("click", "#btnExcelExportDetail", function (e) {

    //    var StartDate =  localStorage.tarihBaslangic;
    //    var EndDate = localStorage.tarihBitis;
    //    var ePostaAdress = $('#ePostaAdress').val();
    //    var Pages = '';
    //    var SubeId = localStorage.subeid

    //    var tarihBaslangic = $("#dateGecerlilikTarihi").val() + ' ' + $("#basSaat").val();
    //    var tarihBitis = $("#dateBitisTarihi").val() + ' ' + $("#bitisSaat").val();
    //    localStorage.tarihBaslangic = tarihBaslangic;
    //    localStorage.tarihBitis = tarihBitis;
    //    localStorage.durum = "tarihAraligi";
    //    location.href = 'ExcelExportDetayliReceteMaliyet?StartDate=' + StartDate + '&EndDate=' + EndDate + '&SubeId=' + SubeId;
    //    //ExcelExportDetayliReceteMaliyet(StartDate, EndDate, ePostaAdress, Pages, SubeId);
    //});

</script>


@*<script>
        $('#tableDetay tbody td img').click(function () {
            var oTable = $('#tableDetay').dataTable();
            var nTr = this.parentNode.parentNode;

            if (this.src.match('details_close')) {
                /* This row is already open - close it */
                this.src = "/img/details_open.jpg";
                oTable.fnClose(nTr);
            }
            else {
                /* Open this row */
                this.src = "/img/details_close.jpg";
                var productgrup = $(this).attr("rel").toString();
                $.get("ProductGroupDetails?durum=" + localStorage.durum + "&tarihBas=" + localStorage.tarihBaslangic + "&tarihBitis=" + localStorage.tarihBitis + "&subeid=" + localStorage.subeid + "&productgrup=" + productgrup, function (details) {
                    oTable.fnOpen(nTr, details, 'details');
                });
            }
        });
    </script>*@



<script type="text/javascript">
    //function ExportToExcel(mytblId) {
    //    var htmltable = document.getElementById('tableRapor');
    //    var html = htmltable.outerHTML;
    //    window.open('data:application/vnd.ms-excel,' + encodeURIComponent(html));
    //}

    function fnExcelReport() {
        var tab_text = "<table border='2px'><tr bgcolor='#87AFC6'>";
        var textRange; var j = 0;
        tab = document.getElementById('tableMasaDetay'); // id of table

        for (j = 0; j < tab.rows.length; j++) {
            tab_text = tab_text + tab.rows[j].innerHTML + "</tr>";
            //tab_text=tab_text+"</tr>";
        }

        tab_text = tab_text + "</table>";
        tab_text = tab_text.replace(/<A[^>]*>|<\/A>/g, "");//remove if u want links in your table
        tab_text = tab_text.replace(/<img[^>]*>/gi, ""); // remove if u want images in your table
        tab_text = tab_text.replace(/<input[^>]*>|<\/input>/gi, ""); // reomves input params

        var ua = window.navigator.userAgent;
        var msie = ua.indexOf("MSIE ");

        if (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./))      // If Internet Explorer
        {
            txtArea1.document.open("txt/html", "replace");
            txtArea1.document.write(tab_text);
            txtArea1.document.close();
            txtArea1.focus();
            sa = txtArea1.document.execCommand("SaveAs", true, "Say Thanks to Sumit.xls");
        }
        else                 //other browser not tested on IE 11
            sa = window.open('data:application/vnd.ms-excel,' + encodeURIComponent(tab_text));

        return (sa);
    }
</script>

<script type="text/javascript">

    jQuery(document).ready(function () {
        //
        var days = 31; // Days you want to subtract
        var date = new Date();
        var last = new Date(date.getTime() - (days * 24 * 60 * 60 * 1000));
        var day = last.getDate();
        var month = last.getMonth() + 1;
        var year = last.getFullYear();
        var outputDefault = year + '-' +
            (('' + month).length < 2 ? '0' : '') + month + '-' +
            (('' + day).length < 2 ? '0' : '') + day;

        var days = 7; // haftalık
        var date = new Date();
        var last = new Date(date.getTime() - (days * 24 * 60 * 60 * 1000));
        var day = last.getDate();
        var month = last.getMonth() + 1;
        var year = last.getFullYear();
        var outputHaftalik = year + '-' +
            (('' + month).length < 2 ? '0' : '') + month + '-' +
            (('' + day).length < 2 ? '0' : '') + day;

        var days = 31; // aylık
        var date = new Date();
        var last = new Date(date.getTime() - (days * 24 * 60 * 60 * 1000));
        var day = last.getDate();
        var month = last.getMonth() + 1;
        var year = last.getFullYear();
        var outputAylik = year + '-' +
            (('' + month).length < 2 ? '0' : '') + month + '-' +
            (('' + day).length < 2 ? '0' : '') + day;

        var d = new Date(); // endDate
        var month = d.getMonth() + 1;
        var day = d.getDate();
        var hours = d.getHours();
        var minut = d.getMinutes();
        var second = d.getSeconds();
        var output = d.getFullYear() + '-' +
            (('' + month).length < 2 ? '0' : '') + month + '-' +
            (('' + day).length < 2 ? '0' : '') + day;

         //Veri Getir butonu click durumu
        $(document).on("click", "#btnEpostasaveDetail", function (e) {

            var StartDate = '@ViewBag.StartDateTime'; //localStorage.tarihBaslangic;//$("#dateGecerlilikTarihi").val() + ' ' + $("#basSaat").val();
            var EndDate ='@ViewBag.EndDateTime ' ;//localStorage.tarihBitis;//$("#dateBitisTarihi").val() + ' ' + $("#bitisSaat").val();
            var ePostaAdress = $('#ePostaAdress').val();
            var Pages = '@(ViewBag.Pages)';
            var SubeId = '@(ViewBag.SubeId)';
            SendReportMail(StartDate, EndDate, ePostaAdress, Pages, SubeId);
        });




        //console.log(StartDate);
        function SendReportMail(StartDate, EndDate, ePostaAdress, Pages, SubeId) {
            document.getElementById("loading").setAttribute("class", "myloading-active");
            document.getElementById("contbody").setAttribute("style", "position:fixed;");
            $.ajax({
                url: '/SubeUrunler/SendReportMail?StartDate=' + StartDate + '&EndDate=' + EndDate + '&ePostaAdress=' + ePostaAdress + '&Pages=' + Pages + '&SubeId=' + SubeId + '',
                type: 'GET',
                beforeSend: function (request) {
                    //mApp.blockPage();
                },
                complete: function () {
                    window.setTimeout(function () {
                        //mApp.unblockPage();
                    }, 100);
                },
                dataType: 'json',
                success: function (data) {
                    var resultObj = JSON.parse(JSON.stringify(data));
                    SuccessAlert(resultObj.UserMessage);

                    //console.log(data);

                    setTimeout(function () {
                        @*parent.location = "@Url.Action("List", "CiroRaporlar")";*@
                        window.location.reload();
                    }, 500);
                }
            });
        }
    });
</script>