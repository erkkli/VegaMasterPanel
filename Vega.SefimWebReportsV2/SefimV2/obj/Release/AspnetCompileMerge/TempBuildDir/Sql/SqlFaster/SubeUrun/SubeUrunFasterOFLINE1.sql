DECLARE @Sube nvarchar(100) = '{SUBEADI}';
DECLARE @par1 nvarchar(20) = '{TARIH1}';
DECLARE @par2 nvarchar(20) = '{TARIH2}';

DECLARE @KASALAR nvarchar(20) = '{KASALAR}';
DECLARE @SUBELER nvarchar(20) = '{SUBELER}';



SELECT 
T.Sube1,
T.Kasa,
T.ID,
SUM(T.MIKTAR) MIKTAR,
SUM(T.TUTAR) TUTAR
FROM (


  (SELECT
     (SELECT SUBEADI
      FROM @SUBELER
      WHERE IND=FSB.SUBEIND) AS Sube1,

     (SELECT KASAADI
      FROM @KASALAR
      WHERE IND=FSB.KASAIND) AS Kasa,

     (SELECT IND
      FROM @KASALAR
      WHERE IND=FSB.KASAIND) AS ID,
          SUM(FSH.MIKTAR) AS MIKTAR,
          SUM((((MIKTAR*SATISFIYATI) * (100-ISNULL(FSH.ISK1, 0))/100) * (100-ISNULL(FSH.ISK2, 0))/100) * (100-ISNULL(FSB.ALTISKORAN, 0))/100) AS TUTAR
   FROM TBLFASTERSATISHAREKET AS FSH
   LEFT JOIN TBLFASTERSATISBASLIK AS FSB ON FSH.BASLIKIND=FSB.BASLIKIND
   AND FSH.SUBEIND=FSB.SUBEIND
   AND FSH.KASAIND=FSB.KASAIND
   LEFT JOIN TBLFASTERSTOKLAR AS STK ON FSH.STOKIND=STK.STOKNO
   WHERE FSH.ISLEMTARIHI>=@par1
     AND FSH.ISLEMTARIHI<=@par2
     AND ISNULL(FSB.IADE, 0)=0
   GROUP BY FSB.SUBEIND,
            FSB.KASAIND
			
	UNION ALL
	SELECT
     (SELECT SUBEADI
      FROM @SUBELER
      WHERE IND=FSB.SUBEIND) AS Sube1,

     (SELECT KASAADI
      FROM @KASALAR
      WHERE IND=FSB.KASAIND) AS Kasa,

     (SELECT IND
      FROM @KASALAR
      WHERE IND=FSB.KASAIND) AS ID,
          SUM(FSH.MIKTAR)*-1 AS MIKTAR,
          SUM((((MIKTAR*SATISFIYATI) * (100-ISNULL(FSH.ISK1, 0))/100) * (100-ISNULL(FSH.ISK2, 0))/100) * (100-ISNULL(FSB.ALTISKORAN, 0))/100) *-1.00 AS TUTAR
   FROM TBLFASTERSATISHAREKET AS FSH
   LEFT JOIN TBLFASTERSATISBASLIK AS FSB ON FSH.BASLIKIND=FSB.BASLIKIND
   AND FSH.SUBEIND=FSB.SUBEIND
   AND FSH.KASAIND=FSB.KASAIND
   LEFT JOIN TBLFASTERSTOKLAR AS STK ON FSH.STOKIND=STK.STOKNO
   WHERE FSH.ISLEMTARIHI>=@par1
     AND FSH.ISLEMTARIHI<=@par2
     AND ISNULL(FSB.IADE, 0)=1
   GROUP BY FSB.SUBEIND,
            FSB.KASAIND
			
			) ) T
			GROUP BY 
			T.Sube1,
T.Kasa,
T.ID