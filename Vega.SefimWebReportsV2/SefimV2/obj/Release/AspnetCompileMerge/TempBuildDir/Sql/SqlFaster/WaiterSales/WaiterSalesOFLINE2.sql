DECLARE @Sube nvarchar(100) = '{SUBE}';
DECLARE @par1 nvarchar(20) = '{TARIH1}';
DECLARE @par2 nvarchar(20) = '{TARIH2}';
DECLARE @par3 nvarchar(100) = '{Personel}';

;WITH 
      ISLEMSAY AS (            SELECT COUNT(FSB.IND) SAY,FSH.PERKODU
                    FROM TBLFASTERSATISHAREKET AS FSH
         LEFT JOIN TBLFASTERSATISBASLIK AS FSB ON FSH.BASLIKIND=FSB.BASLIKIND
                    WHERE FSB.ISLEMTARIHI>=@par1
                      AND FSB.ISLEMTARIHI<=@par2
                      AND ISNULL(FSB.IADE, 0)=0
                     GROUP BY FSH.PERKODU)

SELECT T.Sube1,
       --T.Kasa,
       --T.ID,
	  AVG(ISLEMSAYISI) ISLEMSAYISI,
       SUM(T.MIKTAR) MIKTAR,
       SUM(T.TUTAR) TUTAR,  
       T.PERKODU
FROM (
        (SELECT
           (SELECT SUBEADI
            FROM TBLKRDSUBELER 
            WHERE IND=FSB.SUBEIND) AS Sube1,

           (SELECT KASAADI
            FROM TBLFASTERKASALAR
            WHERE IND=FSB.KASAIND) AS Kasa,

           (SELECT IND
            FROM TBLFASTERKASALAR
            WHERE IND=FSB.KASAIND) AS ID,
	   AVG(SAY) ISLEMSAYISI,
                SUM(FSH.MIKTAR) AS MIKTAR,
                SUM((((MIKTAR*SATISFIYATI) * (100-ISNULL(FSH.ISK1, 0))/100) * (100-ISNULL(FSH.ISK2, 0))/100) * (100-ISNULL(FSB.ALTISKORAN, 0))/100) AS TUTAR,
                STK.MALINCINSI AS ProductName,
                FSH.PERKODU
         FROM TBLFASTERSATISHAREKET AS FSH
         LEFT JOIN TBLFASTERSATISBASLIK AS FSB ON FSH.BASLIKIND=FSB.BASLIKIND
         AND FSH.SUBEIND=FSB.SUBEIND
         AND FSH.KASAIND=FSB.KASAIND
         LEFT JOIN TBLFASTERSTOKLAR AS STK ON FSH.STOKIND=STK.STOKNO
		  LEFT JOIN ISLEMSAY ON ISLEMSAY.PERKODU=FSH.PERKODU
         WHERE FSH.ISLEMTARIHI>=@par1
           AND FSH.ISLEMTARIHI<=@par2
           AND ISNULL(FSB.IADE, 0)=0
         GROUP BY FSB.SUBEIND,
                  FSB.KASAIND,
                  STK.MALINCINSI,
                  FSH.PERKODU, 
				    FSB.IND
         UNION ALL SELECT
           (SELECT SUBEADI
            FROM TBLFASTERKASALAR
            WHERE IND=FSB.SUBEIND) AS Sube1,

           (SELECT KASAADI
            FROM TBLFASTERKASALAR
            WHERE IND=FSB.KASAIND) AS Kasa,

           (SELECT IND
            FROM TBLFASTERKASALAR
            WHERE IND=FSB.KASAIND) AS ID,
			   AVG(SAY)*-1 ISLEMSAYISI,
                          SUM(FSH.MIKTAR)*-1.00 AS MIKTAR,
                          SUM((((MIKTAR*SATISFIYATI) * (100-ISNULL(FSH.ISK1, 0))/100) * (100-ISNULL(FSH.ISK2, 0))/100) * (100-ISNULL(FSB.ALTISKORAN, 0))/100) *-1.00 AS TUTAR,
                          STK.MALINCINSI AS ProductName,
                          FSH.PERKODU
         FROM TBLFASTERSATISHAREKET AS FSH
         LEFT JOIN TBLFASTERSATISBASLIK AS FSB ON FSH.BASLIKIND=FSB.BASLIKIND
         AND FSH.SUBEIND=FSB.SUBEIND
         AND FSH.KASAIND=FSB.KASAIND
         LEFT JOIN TBLFASTERSTOKLAR AS STK ON FSH.STOKIND=STK.STOKNO
		  LEFT JOIN ISLEMSAY ON ISLEMSAY.PERKODU=FSH.PERKODU
         WHERE FSH.ISLEMTARIHI>=@par1
           AND FSH.ISLEMTARIHI<=@par2
           AND ISNULL(FSB.IADE, 0)=1
         GROUP BY FSB.SUBEIND,
                  FSB.KASAIND,
                  STK.MALINCINSI,
                  FSH.PERKODU,  FSB.IND)) T
GROUP BY T.Sube1,
         --T.Kasa,
         --T.ID,
		-- T.ISLEMSAYISI,
         T.PERKODU
		 order by TUTAR Desc