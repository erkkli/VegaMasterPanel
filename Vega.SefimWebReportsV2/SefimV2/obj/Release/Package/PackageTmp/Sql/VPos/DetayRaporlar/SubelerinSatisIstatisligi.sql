DECLARE @Sube nvarchar(100) = '{SUBE}';
declare @Sube2 nvarchar(100) = '{SUBE2}';
declare @Kasa nvarchar(100) = '{KASAKODU}';
DECLARE @Trh1 nvarchar(20) = '{TARIH1}';
DECLARE @Trh2 nvarchar(20) = '{TARIH2}';
DECLARE @EndDate nvarchar(20) ='{EndDate}';


WITH Toplamsatis AS 
(
--nakit
SELECT 
@Sube as Sube, 
(TUTAR*KUR) AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,0 acikmasalar,
0 AS zayi , 0 PaketToplam,
	   case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=1 AND IADE=0 AND IPTAL=0 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 ) 


UNION ALL
SELECT 
@Sube as Sube, 
(TUTAR*KUR)*-1 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,0 acikmasalar,
0 AS zayi , 0 PaketToplam,
case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=1 AND IADE=1 AND IPTAL=0 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 ) 

--kredi kartý
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, (TUTAR*KUR) AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,0 acikmasalar,
0 AS zayi , 0 PaketToplam,
case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=2 AND IADE=0 AND IPTAL=0 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 )  


UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, (TUTAR*KUR)*-1 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,0 acikmasalar,
0 AS zayi , 0 PaketToplam,
case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=2 AND IADE=1 AND IPTAL=0 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 )  


--ticket hediyeceki
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, (TUTAR*KUR)  AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,0 acikmasalar,
0 AS zayi , 0 PaketToplam,
case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=3 AND IADE=0 AND IPTAL=0 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 )  

UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, (TUTAR*KUR)*-1 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,0 acikmasalar,
0 AS zayi , 0 PaketToplam,
case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=3 AND IADE=1 AND IPTAL=0 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 )  

--acikhesap
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0  AS Ticket, (TUTAR*KUR) AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,0 acikmasalar,
0 AS zayi , 0 PaketToplam,
case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=4 AND IADE=0 AND IPTAL=0 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 )  

UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, (TUTAR*KUR)*-1 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,0 acikmasalar,
0 AS zayi , 0 PaketToplam,
case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE ISLEMTIPI=4 AND IADE=1 AND IPTAL=0 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 ) 

--satýþadet
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0  AS Ticket, 0 AS Debit, 0 AS ikram, COUNT(*) AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,0 acikmasalar,
0 AS zayi , 0 PaketToplam,
case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE IADE=0 AND IPTAL=0 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)  
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 )  
GROUP BY OLUSTURMATARIHI


UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, COUNT(*)*-1 AS TableNo, 0 AS Discount, 0 AS iptal,0 AS iade,0 acikmasalar,
0 AS zayi , 0 PaketToplam,
case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE IADE=1 AND IPTAL=0 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 ) 
GROUP BY OLUSTURMATARIHI

--iade
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo, 0 AS Discount, 0 AS iptal,sum(TUTAR) iade,0 acikmasalar,
0 AS zayi , 0 PaketToplam,
case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM TBLSPOSSATISTAHSILAT WITH(NOLOCK)
WHERE IADE=1 AND IPTAL=0 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 )  
GROUP BY OLUSTURMATARIHI

--indirim
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0  AS Ticket,0 AS Debit, 0 AS ikram, 0 AS TableNo,  (H.ISKTUTARI)  AS Discount, 0 AS iptal,0 AS iade,0 acikmasalar,
0 AS zayi , 0 PaketToplam,
case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM TBLSPOSSATISHAREKET H WITH(NOLOCK)
LEFT JOIN TBLSPOSSATISBASLIK B WITH(NOLOCK) ON B.IND=H.BASLIKIND
WHERE ISKORANI1>0  AND IADE=0 AND B.IPTAL=0 
AND case when CAST(B.OLUSTURMATARIHI AS time)< @EndDate then CAST(B.OLUSTURMATARIHI-1 AS date) else CAST(B.OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(B.OLUSTURMATARIHI AS time)< @EndDate then CAST(B.OLUSTURMATARIHI-1 AS date) else CAST(B.OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 )  


UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo,  (H.ISKTUTARI)*-1  AS Discount, 0 AS iptal,0 AS iade,0 acikmasalar,
0 AS zayi , 0 PaketToplam,
case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM TBLSPOSSATISHAREKET H WITH(NOLOCK)
LEFT JOIN TBLSPOSSATISBASLIK B WITH(NOLOCK) ON B.IND=H.BASLIKIND
WHERE ISKORANI1>0 AND B.IADE=1 AND B.IPTAL=0 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 )  


--iptal
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo,  0  AS Discount, MIKTAR*FIYAT AS iptal,0 AS iade,0 acikmasalar,
0 AS zayi , 0 PaketToplam,
case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM TBLSPOSSATISHAREKETLOG H WITH(NOLOCK)
LEFT JOIN TBLSPOSSATISBASLIKLOG B WITH(NOLOCK) ON B.IND=H.BASLIKIND
WHERE  B.IADE=0 AND B.IPTAL=0 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 ) 


--paket
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo,  0  AS Discount, 0 AS iptal,0 AS iade,0 acikmasalar,
0 AS zayi , sum(b.TUTAR) PaketToplam,
case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM TBLSPOSSATISBASLIK B WITH(NOLOCK)
WHERE  B.IADE=0 AND B.IPTAL=0 AND ISNULL(B.P_KAYNAK,'')<>''
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 )  
GROUP BY OLUSTURMATARIHI

--acikmasalar
UNION ALL
SELECT 
@Sube as Sube, 
0 AS Cash, 0 AS Credit, 0 AS Ticket, 0 AS Debit, 0 AS ikram, 0 AS TableNo,  0  AS Discount,0 AS iptal,0 AS iade,B.TUTAR acikmasalar,
0 AS zayi , 0 PaketToplam,
case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end AS DateStrNow,
       CAST(DAY(case when CAST(OLUSTURMATARIHI AS time)< @EndDate then OLUSTURMATARIHI-1 else OLUSTURMATARIHI end) AS INT) AS DayNumber
FROM  TBLSPOSSATISBASLIK B WITH(NOLOCK) 
WHERE  B.IADE=0 AND B.IPTAL=0 and B.BEKLEYENFIS=1 AND ISNULL(B.P_KAYNAK,'')='' 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end>=@Trh1 
AND case when CAST(OLUSTURMATARIHI AS time)< @EndDate then CAST(OLUSTURMATARIHI-1 AS date) else CAST(OLUSTURMATARIHI AS date) end<=@Trh2
AND SUBEIND IN (SELECT IND FROM TBLSPOSSUBELER  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0 AND KODU=@Sube2)   
AND KASAIND IN (SELECT IND FROM TBLSPOSKASALAR  WITH(NOLOCK) WHERE ISNULL(IsDeleted,0)=0AND Charindex('&'+KODU+'&',@kasa )>0 ) 


)


SELECT 
 ROW_NUMBER() OVER(ORDER BY CAST(CONVERT(VARCHAR, DATEADD(DAY, 0, DATEDIFF(DAY, 0, DateStrNow)), 100) AS DATETIME) ASC) AS DayCount,
  sum(Cash) Cash,
  sum(credit) credit,
  sum(ticket) ticket,
  sum(debit) debit,
  sum(0) online, 
  sum(ikram) ikram,
  sum(Cash+Credit+Ticket+Debit) ToplamCiro,
  DateStrNow,
  DayNumber
FROM toplamsatis  
GROUP BY 
DateStrNow,
DayNumber
ORDER BY DateStrNow
