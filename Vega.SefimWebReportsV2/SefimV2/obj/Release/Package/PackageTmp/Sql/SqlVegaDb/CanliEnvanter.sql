declare @par1 nvarchar(20) = '{DepoId}';

WITH TBLANLIKENVANTER AS (
SELECT
ST.IND,ST.STOKKODU,ST.MALINCINSI,
SUM(CASE WHEN IADE=0 THEN HRK.MIKTAR ELSE -1*HRK.MIKTAR END) AS MIKTAR,SUBEADI,DEP.IND AS DEPOIND FROM TBLFASTERSATISBASLIK   AS HR
LEFT JOIN TBLFASTERSATISHAREKET AS HRK ON HR.BASLIKIND=HRK.BASLIKIND AND HR.SUBEIND=HRK.KASAIND AND HR.BARCODE=HRK.BASBARCODE
LEFT JOIN F0101TBLSTOKLAR AS ST ON ST.IND=HRK.STOKIND
LEFT JOIN F0101TBLKRDSUBELER AS SUB ON SUB.IND=HR.SUBEIND
LEFT JOIN F0101TBLDEPOLAR AS DEP ON DEP.DEPOKODU=SUBEADI
WHERE ISNULL(VEGABELGEIND,0)=0 AND CONVERT(NVARCHAR(10),HR.TARIH,102)= CONVERT(NVARCHAR(10),GETDATE(),102)
GROUP BY
DEP.IND,
SUBEADI,
ST.IND,ST.STOKKODU,ST.MALINCINSI)

SELECT

ST.STOKKODU,ST.MALINCINSI,
DEPOKODU,
SUM(ENVANTER) AS ENVANTER,
ISNULL((SELECT SUM(MIKTAR) FROM TBLANLIKENVANTER WHERE IND=HR.STOKNO AND DEPOIND=HR.DEPO),0) AS CANLI,
SUM(ENVANTER)-ISNULL((SELECT SUM(MIKTAR) FROM TBLANLIKENVANTER WHERE IND=HR.STOKNO AND DEPOIND=HR.DEPO),0) AS CANLIENNVATER
 FROM F0101D0003TBLDEPOENVANTER AS HR
LEFT JOIN F0101TBLSTOKLAR AS ST ON ST.IND=HR.STOKNO
LEFT JOIN F0101TBLDEPOLAR AS DEP ON DEP.IND=HR.DEPO
WHERE DEP.IND=@par1 AND ST.KOD5='MASTER'
GROUP BY
DEPOKODU,
HR.STOKNO,
ST.STOKKODU,ST.MALINCINSI,HR.DEPO