
WITH TBLVERI AS (
SELECT * FROM (
SELECT T.SUBEADI,T.KOD3,SUM(T.MIKTAR) AS MIKTAR,sum(Tutar) as TUTAR FROM (
SELECT 
NEWID() AS TEKIL,
KOD1 AS KOD3,
SUBEADI,
SUM(Quantity) as MIKTAR,
SUM(Quantity*Price) AS TUTAR

 FROM [dbo].[Bill] AS HR
WHERE Date>='{TARIH1}'  AND Date<='{TARIH2}' #SUBEADIWHERE# #TEKTRHWHERE#
AND KOD3 LIKE '%YAN URUNLER%'
group by
KOD1,
SUBEADI
UNION
SELECT 
NEWID() AS TEKIL,
HAR.VEGAKOD1,
SUBEADI,
SUM(MIKTAR*ANAMIKTAR) as Miktar,
SUM(MIKTAR*ANAMIKTAR*HAR.Price) as TUTAR

 FROM [dbo].TBLBILLOPTIONS AS HAR
 LEFT JOIN [Bill] AS BAS ON BAS.Id=HAR.BIND
WHERE TARIH>'{TARIH1}'  AND TARIH<='{TARIH2}' #SUBEADIWHERE# #TEKTRHWHERE#
AND HAR.KOD3 LIKE '%YAN URUNLER%'
group by
HAR.VEGAKOD1,
SUBEADI,
URUNADI) AS T
group by
T.SUBEADI,T.KOD3
) AS T) 

SELECT 
*,
(SELECT SUM (MIKTAR) FROM TBLVERI WHERE SUBEADI=VER.SUBEADI) AS SUBEMIKTAR,
(SELECT SUM (TUTAR) FROM TBLVERI WHERE SUBEADI=VER.SUBEADI) AS SUBETOPLAMTUTAR,
(SELECT SUM (TUTAR) FROM TBLVERI) AS TOPLAMTUTAR,
(TUTAR/(SELECT SUM (TUTAR) FROM TBLVERI))*100 AS ORAN
FROM TBLVERI AS VER